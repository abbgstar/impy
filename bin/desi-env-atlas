#!/bin/bash
# Set up DESI code

unset PYTHONPATH # Clear PYTHONPATH

export DESI_ROOT=$IM_WORK_DIR/desi
export DESI_PRODUCT_ROOT=$IM_GITREPOS/desihub
export DESIMODEL=$DESI_PRODUCT_ROOT/desimodel
export DESI_SPECTRO_SIM=$DESI_ROOT/spectro/sim
export DESI_SPECTRO_DATA=$DESI_ROOT/spectro/data
export DESI_SPECTRO_REDUX=$DESI_ROOT/spectro/redux
export SPECPROD=dailytest
export PIXPROD=dailytest

## Clone or update all the package dependencies.
pushd $DESI_PRODUCT_ROOT
for package in desiutil specter specsim desitarget desispec desisim desisurvey surveysim \
                        desimodel redrock redrock-templates; do
  if [ -d $package ]; then
    echo 'Updating '$package
    cd $package
    git pull
    cd ..
  else
      git clone git@github.com:desihub/$package
  fi
done
popd

# Update PATH and PYTHONPATH
for package in desiutil specter desitarget desispec desisim \
                        desisurvey surveysim desimodel redrock; do
  export PATH=$DESI_PRODUCT_ROOT/$package/bin:$PATH
  export PYTHONPATH=$DESI_PRODUCT_ROOT/$package/py:$PYTHONPATH
done
export PYTHONPATH=$DESI_PRODUCT_ROOT/specsim:$PYTHONPATH
export PYTHONPATH=$DESI_PRODUCT_ROOT/simqso:$PYTHONPATH

# Check out the desimodel data files (in svn)
# cd $DESIMODEL
# svn export https://desi.lbl.gov/svn/code/desimodel/trunk/data

# Check out calibration and template files
#username=my_nersc_account_username
#export DESI_ROOT=$HOME/desi/
#mkdir -p $DESI_ROOT/spectro/templates/basis_templates
#cd $DESI_ROOT/spectro/templates/basis_templates
#svn export svn+ssh://${username}@dtn01.nersc.gov/global/project/projectdirs/desi/spectro/calib/svn/basis_templates/tags/v2.5

export DESI_CCD_CALIBRATION_DATA=$DESI_ROOT/spectro/calib/ccd_calibration_data

# Templates
export RR_TEMPLATE_DIR=$DESI_PRODUCT_ROOT/redrock-templates
export DESI_BASIS_TEMPLATES=$DESI_ROOT/spectro/templates/basis_templates/v2.6

source activate desi
