#!/bin/bash
# Set up the software environment we need in order to run various Legacy Surveys
# code (legacypipe) at NERSC.

echo 'Loading legacypipe software'

# The desiconda software stack gets loaded by legacypipe-env, below.
#desiconda_version=20190311-1.2.7-img
#module use /global/common/software/desi/$NERSC_HOST/desiconda/$desiconda_version/modulefiles
#module load desiconda

# Set up the software and dependencies
export LEGACYPIPE_DIR=$HOME/repos/git/legacypipe
echo '$LEGACYPIPE_DIR='$LEGACYPIPE_DIR

source $LEGACYPIPE_DIR/bin/legacypipe-env

export PATH=$LEGACYPIPE_DIR/bin:$PATH
export PYTHONPATH=$LEGACYPIPE_DIR/py:$PYTHONPATH

#export LEGACY_SURVEY_DIR=/global/cscratch1/sd/desiproc/dr7
#export LEGACY_SURVEY_DIR=/global/project/projectdirs/cosmo/work/legacysurvey/dr6
export LEGACY_SURVEY_DIR=/global/project/projectdirs/cosmo/work/legacysurvey/dr7
echo '$LEGACY_SURVEY_DIR='$LEGACY_SURVEY_DIR

# For calibs, also set up legacyzpts
#export LEGACYZPTS_DIR=$HOME/repos/git/legacyzpts
#echo '$LEGACYZPTS_DIR='$LEGACYZPTS_DIR
#export PATH=$LEGACYZPTS_DIR/bin:$PATH
#export PYTHONPATH=$LEGACYZPTS_DIR/py:$PYTHONPATH

# Some NERSC-specific options to get MPI working properly.
export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export KMP_AFFINITY=disabled
export MPICH_GNI_FORK_MODE=FULLCOPY

##################################################
# Notes on custom-installing tractor and astrometry.net
#
# desiconda_version=20190311-1.2.7-img
# module use /global/common/software/desi/$NERSC_HOST/desiconda/$desiconda_version/modulefiles
# module load desiconda
# cd $HOME/repos/git
# git clone https://github.com/dstndstn/astrometry.net.git
# cd astrometry.net/
# python setup.py install --prefix=$HOME/repos/build/$NERSC_HOST

# cd ..
# git clone https://github.com/dstndstn/tractor.git
# cd tractor/
# make
# export SUITESPARSE_LIB_DIR="${SuiteSparse_PREFIX}/lib"
# export BLAS_LIB="${blas_LIBS_CC}"
# module load eigen3
# export PKG_CONFIG_PATH=${PKG_CONFIG_PATH}:$EIGEN3_DIR/share/pkgconfig
# export PYTHON_CONFIG=python3-config
# make ceres
# python setup.py install --prefix=$HOME/repos/build/$NERSC_HOST

# export PATH=$HOME/repos/build/$NERSC_HOST/bin:$PATH
# export PYTHONPATH=$HOME/repos/build/$NERSC_HOST/lib/python3.6/site-packages:$PYTHONPATH
##################################################
