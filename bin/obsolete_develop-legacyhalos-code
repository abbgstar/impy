#!/bin/bash

# Little script that must be run in order to run legacypipe.  See
#  https://desi.lbl.gov/trac/wiki/DecamLegacy/HowToInstallCode
# for some details.

# Note that if I need to install more packages on top of the default desiconda
# installation, first create a new conda environment (once), activate it, and
# install a package using conda or pip.  Subsequently, just activate the
# environment.
#
#   desiconda_version=20170719-1.1.9-imaging
#   module use /global/common/$NERSC_HOST/contrib/desi/modulefiles
#   module load desiconda/$desiconda_version
#   conda create --prefix $CSCRATCH/conda-envs/legacypipe --file $DESICONDA/pkg_list.txt 
#   source activate $CSCRATCH/conda-envs/legacypipe

# To test everything, run
#   python $LEGACYPIPE_DIR/py/test/runbrick_test.py

dr=dr5-new
# desiconda_version=20170719-1.1.9-imaging
desiconda_version=20180103-1.2.3-img

echo 'Loading software version desiconda/'$desiconda_version
module use /global/common/software/desi/$NERSC_HOST/desiconda/$desiconda_version/modulefiles
module load desiconda

# Clone legacypipe to common scratch (but don't 'git pull' automatically) and
# add it to my PYTHONPATH.
export LEGACYPIPE_DIR=${CSCRATCH}/repos/legacypipe
export LEGACYHALOS_DIR=${CSCRATCH}/legacyhalos
export LEGACYHALOS_CODE_DIR=${CSCRATCH}/repos/legacyhalos

if [ ! -d "$LEGACYPIPE_DIR" ]; then
    echo 'Cloning legacypipe to '$LEGACYPIPE_DIR
    git clone git@github.com:legacysurvey/legacypipe.git $LEGACYPIPE_DIR
fi
export PATH=$LEGACYPIPE_DIR/bin:$PATH
export PATH=$LEGACYHALOS_CODE_DIR/bin:$PATH

export PYTHONPATH=$LEGACYPIPE_DIR/py:$PYTHONPATH
export PYTHONPATH=$LEGACYHALOS_CODE_DIR:$PYTHONPATH

export OMP_NUM_THREADS=1
export MPICH_GNI_FORK_MODE=FULLCOPY
export KMP_AFFINITY=disabled

echo 'Loading dust and unwise_coadds modules.'
module use $LEGACYPIPE_DIR/bin/modulefiles/cori
module load unwise_coadds
module load unwise_coadds_timeresolved
module load dust

#export LEGACY_SURVEY_DIR=/global/cscratch1/sd/desiproc/$dr
export LEGACY_SURVEY_DIR=/global/cscratch1/sd/desiproc/$dr
echo 'Setting environment LEGACY_SURVEY_DIR='$LEGACY_SURVEY_DIR

echo 'Moving to directory '$CSCRATCH
cd $CSCRATCH
